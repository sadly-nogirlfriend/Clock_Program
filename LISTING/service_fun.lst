C51 COMPILER V9.54   SERVICE_FUN                                                           10/14/2024 10:24:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE SERVICE_FUN
OBJECT MODULE PLACED IN ..\OUTPUT\service_fun.obj
COMPILER INVOKED BY: E:\Keil_C51\C51\BIN\C51.EXE ..\SOURCE\service_fun.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\SOURCE) DEBU
                    -G OBJECTEXTEND PRINT(..\LISTING\service_fun.lst) TABS(2) OBJECT(..\OUTPUT\service_fun.obj)

line level    source

   1          /*******************************************************
   2          file.name : service_fun.c
   3          version : 1.1
   4          description : 存放了一些用于程序运行的功能函数
   5          *******************************************************/
   6          
   7          // 包含的头文件
   8          #include "service_fun.h"
   9          #include <reg51.h>
  10          #include "key.h"
  11          #include "led.h"
  12          
  13          // 宏定义
  14          #define       WINDOW1       2
  15          #define       WINDOW2       3
  16          #define       WINDOW3       4
  17          #define       CLOCK_MOD     5
  18          
  19          // 定义的变量
  20          unsigned int mins = 0;
  21          unsigned int hours = 0;
  22          unsigned int day = 1;
  23          unsigned int mounth = 1;
  24          unsigned int year = 2000; 
  25          int min_time = 0; 
  26          
  27          unsigned char window1_num[] = "0000";  //用于计数，窗口1
  28          unsigned char window2_num[] = "0000";  //用于计数，窗口2
  29          unsigned char window3_num[] = "0000";  //用于计数，窗口3
  30          unsigned char windows = WINDOW1;  // 用于窗口标记，默认为窗口1
  31          
  32          // 该函数用于日历的进位计算
  33          void time_carry()
  34          {
  35   1        if(min_time == 1000)
  36   1        {
  37   2          mins++;
  38   2          min_time = 0;
  39   2        }
  40   1        if(mins == 60)   //60分钟进1小时
  41   1        {
  42   2          hours++;
  43   2          mins = 0;
  44   2        }
  45   1        if(hours == 24)  //24小时进1天
  46   1        {
  47   2          day++;
  48   2          hours = 0;
  49   2        }
  50   1      
  51   1        // 年月日进位
  52   1          if((year%4 == 0)&&(year%100 != 0)||(year%400 == 0))   // 闰年
  53   1          {
  54   2              switch (mounth)
C51 COMPILER V9.54   SERVICE_FUN                                                           10/14/2024 10:24:19 PAGE 2   

  55   2              {
  56   3              case 1:
  57   3              case 3:
  58   3              case 5:
  59   3              case 7:
  60   3              case 8:
  61   3              case 10:
  62   3              if(day > 31)
  63   3                  {
  64   4                      mounth++;
  65   4                      day = 1;
  66   4                  }
  67   3                  break;
  68   3              case 12:
  69   3                  if(day > 31)
  70   3                  {
  71   4                      year++;
  72   4                      mounth = 1;
  73   4                      day = 1;
  74   4                  }
  75   3                  break;
  76   3              case 2:
  77   3                  if(day > 29)
  78   3                  {
  79   4                      mounth++;
  80   4                      day = 1;
  81   4                  }
  82   3                  break;
  83   3              case 4:
  84   3              case 6:
  85   3              case 9:
  86   3              case 11:
  87   3                  if(day > 30)
  88   3                  {
  89   4                      mounth++;
  90   4                      day = 1;
  91   4                  }
  92   3                  break;
  93   3              default:
  94   3                  break;
  95   3              }
  96   2          }
  97   1          else
  98   1        {
  99   2              switch (mounth)
 100   2              {
 101   3              case 1:
 102   3              case 3:
 103   3              case 5:
 104   3              case 7:
 105   3              case 8:
 106   3              case 10:
 107   3              if(day > 31)
 108   3                  {
 109   4                      mounth++;
 110   4                      day = 1;
 111   4                  }
 112   3                  break;
 113   3              case 12:
 114   3                  if(day > 31)
 115   3                  {
 116   4                      year++;
C51 COMPILER V9.54   SERVICE_FUN                                                           10/14/2024 10:24:19 PAGE 3   

 117   4                      mounth = 1;
 118   4                      day = 1;
 119   4                  }
 120   3                  break;
 121   3              case 2:
 122   3                  if(day > 28)
 123   3                  {
 124   4                      mounth++;
 125   4                      day = 1;
 126   4                  }
 127   3                  break;
 128   3              case 4:
 129   3              case 6:
 130   3              case 9:
 131   3              case 11:
 132   3                  if(day > 30)
 133   3                  {
 134   4                      mounth++;
 135   4                      day = 1;
 136   4                  }
 137   3                  break;
 138   3              default:
 139   3                  break;
 140   3              }
 141   2        }
 142   1      }
 143          
 144          // 该函数用于数字转字符串,将四位整数转化为字符串
 145          // 注意数字为无符号整数，一定要大于0
 146          void num2str(unsigned int num,unsigned char* str)
 147          {
 148   1        str[3] = num%10+'0';
 149   1        str[2] = (num/10)%10+'0';
 150   1        str[1] = (num/100)%10+'0';
 151   1        str[0] = (num/1000)%10+'0';
 152   1      }
 153          
 154          // 该函数用于显示对应窗口
 155          void display_windows()
 156          {
 157   1        switch (windows)
 158   1        {
 159   2        case WINDOW1:
 160   2          display_str_once(window1_num);
 161   2          break;
 162   2        case WINDOW2:
 163   2          display_str_once(window2_num);
 164   2          break;
 165   2        case WINDOW3:
 166   2          display_str_once(window3_num);
 167   2          break;
 168   2        default:
 169   2          display_str_once("----");
 170   2          break;
 171   2        }
 172   1      }
 173          
 174          void key1_switch_windows()
 175          {
 176   1        if( (Key_State_Scan(MODEL1,WAITING_RELEASE)>>0) & 1)
 177   1        {
 178   2          windows++;
C51 COMPILER V9.54   SERVICE_FUN                                                           10/14/2024 10:24:19 PAGE 4   

 179   2          if(windows == WINDOW3 + 1)
 180   2          {
 181   3            windows = WINDOW1;
 182   3          }
 183   2        }
 184   1      }
 185          
 186          // 窗口分配：window1 用于时钟
 187          void clock() interrupt 1
 188          {
 189   1        // 标志位清零
 190   1        TF0 = 0;
 191   1        // min_time为60ms
 192   1        TL0 = (65536 - 60000)%256;
 193   1        TH0 = (65536 - 60000)/256;
 194   1        min_time++;
 195   1        time_carry();  // 日历进位操作
 196   1        num2str(mins+hours*100,window1_num);
 197   1        num2str(day+mounth*100,window2_num);
 198   1        num2str(year,window3_num);
 199   1      }
 200          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    769    ----
   CONSTANT SIZE    =      5    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     28       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
